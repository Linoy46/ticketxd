<div class="ag-wrapper">
  <!-- Overlay de carga -->
  <div
    class="loading-overlay"
    *ngIf="isLoading"
    (click)="$event.stopPropagation()"
  >
    <div class="loading-content">
      <div
        class="spinner-border text-light"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Cargando...</span>
      </div>
      <div class="mt-3 text-light">
        <strong>Generando reporte...</strong>
        <p class="mb-0 mt-2">
          Por favor espere, esto puede tomar unos momentos.
        </p>
      </div>
    </div>
  </div>

  <header class="header text-center text-secondary mb-4">
    <h1>Reportes Financieros</h1>
  </header>

  <!-- Tabla de Formatos Presupuestales Generales (Solo para Admin - Puesto 1806) -->
  <div *ngIf="esAdmin" class="mb-4">
    <h3 class="text-secondary mb-3">Formatos Presupuestales Generales</h3>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Formato Presupuestal</th>
            <th>Financiamiento</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>Formato Presupuestal General</td>
            <td>FONE</td>
            <td>
              <button
                class="btn btn-sm btn-primary"
                (click)="descargarFormatoPresupuestalGeneral(1)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="fas fa-download"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
              <button
                class="btn btn-sm btn-success ms-2"
                (click)="descargarFormatoPresupuestalGeneral(1)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="bi bi-file-earmark-arrow-down"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
            </td>
          </tr>
          <tr>
            <td>2</td>
            <td>Formato Presupuestal General</td>
            <td>MAC</td>
            <td>
              <button
                class="btn btn-sm btn-primary"
                (click)="descargarFormatoPresupuestalGeneral(2)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="fas fa-download"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
              <button
                class="btn btn-sm btn-success ms-2"
                (click)="descargarFormatoPresupuestalGeneral(2)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="bi bi-file-earmark-arrow-down"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
            </td>
          </tr>
          <tr>
            <td>3</td>
            <td>Formato Presupuestal General</td>
            <td>Recurso Estatal</td>
            <td>
              <button
                class="btn btn-sm btn-primary"
                (click)="descargarFormatoPresupuestalGeneral(3)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="fas fa-download"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
              <button
                class="btn btn-sm btn-success ms-2"
                (click)="descargarFormatoPresupuestalGeneral(3)"
                [disabled]="isLoadingFormatoGeneral"
              >
                <span *ngIf="!isLoadingFormatoGeneral">
                  <i class="bi bi-file-earmark-arrow-down"></i>
                </span>
                <span
                  *ngIf="isLoadingFormatoGeneral"
                  class="d-flex align-items-center"
                >
                  <div
                    class="spinner-border spinner-border-sm me-2"
                    role="status"
                  >
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                  Generando...
                </span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="container-fluid">
    <!-- Botones de reportes consolidados -->
    <div class="mb-3 d-flex gap-2" *ngIf="esAdmin">
      <button
        class="btn btn-purple compact-btn"
        (click)="descargarConsolidadoDesglose()"
        [disabled]="isLoadingDesglose"
      >
        <span *ngIf="!isLoadingDesglose">
          Consolidado de Desglose por Partida
        </span>
        <span *ngIf="isLoadingDesglose" class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          Generando reporte...
        </span>
      </button>
      <button
        class="btn btn-purple compact-btn"
        (click)="descargarConsolidadoFormatoPorProducto()"
        [disabled]="isLoadingCosteo"
      >
        <span *ngIf="!isLoadingCosteo">
          Consolidado de Costeo por Producto
        </span>
        <span *ngIf="isLoadingCosteo" class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          Generando reporte...
        </span>
      </button>
    </div>
    <!-- Select tipo select2 para áreas administrativas -->
    <mat-form-field
      *ngIf="puedeVerSelectArea"
      style="width: 350px; margin-bottom: 16px"
    >
      <mat-select
        placeholder="Selecciona un área administrativa"
        [(value)]="areaSeleccionada"
      >
        <mat-select-trigger>
          {{ areaSeleccionada?.nombre || "Selecciona un área" }}
        </mat-select-trigger>
        <mat-option>
          <input
            matInput
            placeholder="Buscar área..."
            [(ngModel)]="filtroPuesto"
            (click)="$event.stopPropagation()"
            autocomplete="off"
          />
        </mat-option>
        <mat-option
          *ngFor="
            let area of areasAdministrativas | puestoFilter : filtroPuesto
          "
          [value]="area"
        >
          {{ area.nombre }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Mostrar áreas administrativas asociadas al puesto seleccionado -->
    <div *ngIf="areasAdministrativasSeleccionadas.length > 0" class="mb-3">
      <b>Áreas administrativas asociadas:</b>
      <ul>
        <li *ngFor="let area of areasAdministrativasSeleccionadas">
          {{ area }}
        </li>
      </ul>
    </div>

    <!-- AG-Grid responsivo -->
    <div class="grid-container">
      <ag-grid-angular
        class="ag-theme-quartz grid-responsive"
        style="
          width: 100%;
          height: 500px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        "
        [rowData]="rowData"
        [columnDefs]="columnDefs"
        [gridOptions]="gridOptions"
        [pagination]="true"
        [theme]="myTheme"
        (gridReady)="onGridReady($event)"
      >
      </ag-grid-angular>
    </div>
  </div>
</div>
